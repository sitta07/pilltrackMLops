name: PillTrack MLOps Pipeline üíä

on:
  push:
    tags:
      - 'v*'
      - 'pill-*'
      - 'box-*'
      - 'major-pill-*'
      - 'major-box-*'

# ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏ó Push Lockfile ‡∏Å‡∏•‡∏±‡∏ö GitHub ‡πÑ‡∏î‡πâ
permissions:
  contents: write

jobs:
  train-and-deploy:
    name: Smart Training Pipeline
    runs-on: self-hosted
    env:
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Global Environment Variables
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "TAG_NAME=$TAG" >> $GITHUB_ENV

      # ‚úÖ [Universal Path] ‡∏£‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ Path
      - name: üîó Link Local Dataset to Runner (Universal)
        run: |
          TARGET_DATA_PATH="$HOME/Desktop/pilltrackMLops/data"
          echo "üîç Auto-detecting dataset at: $TARGET_DATA_PATH"
          
          mkdir -p data
          
          # Link Box
          if [ -d "$TARGET_DATA_PATH/raw_box" ]; then
             ln -sfn "$TARGET_DATA_PATH/raw_box" ./data/raw_box
             echo "‚úÖ Box Data Linked"
          else
             echo "‚ö†Ô∏è Warning: Box data not found at $TARGET_DATA_PATH/raw_box"
          fi
          
          # Link Pill (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á raw ‡πÅ‡∏•‡∏∞ raw_pill)
          if [ -d "$TARGET_DATA_PATH/raw_pill" ]; then
            ln -sfn "$TARGET_DATA_PATH/raw_pill" ./data/raw_pill
            echo "‚úÖ Pill Data Linked (found raw_pill)"
          elif [ -d "$TARGET_DATA_PATH/raw" ]; then
            ln -sfn "$TARGET_DATA_PATH/raw" ./data/raw_pill
            echo "‚úÖ Pill Data Linked (found raw)"
          else
            echo "‚ùå ERROR: Could not find pill dataset!"
            exit 1
          fi
          ls -la data/

      - name: Setup Venv
        run: |
          if [ ! -d "venv" ]; then /opt/homebrew/bin/python3.10 -m venv venv; fi
          echo "$PWD/venv/bin" >> $GITHUB_PATH

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install Pillow transparent-background
          pip install -r requirements.txt
          pip install "dvc[s3]>=3.0" python-dotenv

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: DVC Pull Models
        run: |
          dvc remote modify myremote --local access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          dvc remote modify myremote --local secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          dvc pull experiments/ metrics/ --force || echo "‚ö†Ô∏è No models on S3 yet."

      # ‚úÖ [Incremental Logic] ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ Pill ‡πÄ‡∏ó‡∏£‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Major Tag
      - name: Run Pipeline
        run: |
          echo "üè∑Ô∏è Processing Tag: $TAG_NAME"
          
          # --- BOX Logic ---
          if [[ "$TAG_NAME" =~ "box" ]]; then
            if [[ "$TAG_NAME" =~ "major" ]]; then
              dvc repro train_box -f
            else
              # Box Minor: ‡πÅ‡∏Ñ‡πà Augment & Evaluate (‡πÑ‡∏°‡πà‡πÄ‡∏ó‡∏£‡∏ô‡πÉ‡∏´‡∏°‡πà)
              dvc repro augment_box && dvc commit train_box && dvc repro evaluate_box
            fi
          fi
          
          # --- PILL Logic (Updated for New Class) ---
          if [[ "$TAG_NAME" =~ "pill" ]]; then
            if [[ "$TAG_NAME" =~ "major" ]]; then
              echo "üî¥ Mode: PILL Major Update (Force Full Train)"
              dvc repro train_pill -f
            else
              echo "üü¢ Mode: PILL Incremental Update (Train on new data)"
              # ‡πÉ‡∏ä‡πâ dvc repro ‡πÅ‡∏ó‡∏ô dvc commit ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡πÄ‡∏ó‡∏£‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠ Data ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏° Class)
              dvc repro augment_pill && dvc repro train_pill && dvc repro evaluate_pill
            fi
          fi

      - name: Push Artifacts to DVC
        run: |
          echo "‚òÅÔ∏è Uploading Models to S3..."
          dvc push

      - name: üÜô Update Lockfile to GitHub
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add dvc.lock
          if git diff --staged --quiet; then
            echo "No changes in dvc.lock"
          else
            git commit -m "üÜô update dvc.lock after training [skip ci]"
            git push origin HEAD:main
          fi

      # ‚úÖ [Smart Deploy] ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Path ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      - name: Deploy to S3 Releases
        run: |
          CLEAN_VER=$(echo $TAG_NAME | sed 's/major-//' | sed 's/pill-//' | sed 's/box-//')
          
          if [[ "$TAG_NAME" =~ "pill" ]]; then MODEL_TYPE="pill"; else MODEL_TYPE="box"; fi
          
          # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÇ‡∏°‡πÄ‡∏î‡∏• Finetuned ‡πÑ‡∏´‡∏°? ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Lite_v1 (Main Model)
          # ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏ô Pill ‡πÅ‡∏ö‡∏ö Minor Tag ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà Error
          if [ -d "experiments/arcface_finetuned/$MODEL_TYPE" ]; then
            PATH_TYPE="arcface_finetuned"
            echo "üì¶ Deploying Finetuned Model"
          else
            PATH_TYPE="arcface_lite_v1"
            echo "üì¶ Deploying Main Model (Lite v1)"
          fi
          
          python src/deploy.py \
            --version "$CLEAN_VER" \
            --path "experiments/$PATH_TYPE" \
            --type "$MODEL_TYPE" \
            --bucket "${{ secrets.S3_BUCKET_NAME }}" \
            --note "Auto-deployed for $TAG_NAME"

      # ‚úÖ [Auto-Sync] ‡∏ß‡∏≤‡∏õ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!
      - name: ‚ö°Ô∏è Sync Models to Local Dev Workspace
        run: |
          DEV_WORKSPACE="$HOME/Desktop/pilltrackMLops"
          echo "üöÄ Teleporting models to: $DEV_WORKSPACE"
          
          if [ -d "$DEV_WORKSPACE" ]; then
            cp -R experiments/ "$DEV_WORKSPACE/experiments/"
            cp -R metrics/ "$DEV_WORKSPACE/metrics/" || true
            echo "‚úÖ DONE! Models are ready in your VS Code."
          else
            echo "‚ö†Ô∏è Workspace not found. Skipping sync."
          fi