name: PillTrack MLOps Pipeline üíä

on:
  push:
    tags:
      - 'v*'
      - 'pill-v*'
      - 'box-v*'
      - 'major-*'

jobs:
  train-and-deploy:
    name: Smart Training Pipeline
    runs-on: self-hosted
    
    # ‚ùå ‡∏•‡∏ö env: RUNNER_TOOL_CACHE ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏á‡πâ‡∏≠‡∏°‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß!

    steps:
      # --- 1. SETUP PHASE ---
      - name: Checkout Code
        uses: actions/checkout@v3

      # ‚úÖ ‡∏ó‡πà‡∏≤‡πÑ‡∏°‡πâ‡∏ï‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà: ‡πÉ‡∏ä‡πâ Python ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á + ‡∏™‡∏£‡πâ‡∏≤‡∏á venv
      - name: Setup System Python & Venv
        run: |
          echo "üêç Using System Python 3.10..."
          # ‡∏™‡∏£‡πâ‡∏≤‡∏á venv ‡∏ä‡∏∑‡πà‡∏≠ 'venv' (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
          /opt/homebrew/bin/python3.10 -m venv venv
          
          # üí° Trick ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° path ‡∏Ç‡∏≠‡∏á venv ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô GitHub Path
          # ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Step ‡∏ï‡πà‡∏≠‡πÜ ‡πÑ‡∏õ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ 'python', 'pip', 'dvc' ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
          echo "$PWD/venv/bin" >> $GITHUB_PATH

      - name: Install Dependencies
        run: |
          # ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ pip ‡∏Ñ‡∏∑‡∏≠ pip ‡∏Ç‡∏≠‡∏á venv ‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á source activate)
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[s3] python-dotenv

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: DVC Pull Data
        run: |
          dvc remote modify myremote --local access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          dvc remote modify myremote --local secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          dvc pull

      # --- 2. üß† THE BRAIN: LOGIC ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πä‡∏∞ ---
      - name: Analyze Tag & Execute Pipeline
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "üè∑Ô∏è Detected Tag: $TAG_NAME"

          if [[ "$TAG_NAME" == *"major"* ]]; then
            MODE="FULL"
            echo "üî• Mode: FULL RETRAINING"
          else
            MODE="INCREMENTAL"
            echo "‚ö° Mode: INCREMENTAL UPDATE"
          fi

          if [[ "$TAG_NAME" == *"pill"* ]]; then
            TARGET="PILL"
          elif [[ "$TAG_NAME" == *"box"* ]]; then
            TARGET="BOX"
          else
            TARGET="BOTH"
          fi
          
          echo "üéØ Target: $TARGET"
          echo "----------------------------------------"

          # === PILL PIPELINE ===
          if [[ "$TARGET" == "PILL" ]] || [[ "$TARGET" == "BOTH" ]]; then
            echo "üíä Processing PILL model..."
            if [[ "$MODE" == "INCREMENTAL" ]]; then
               dvc repro augment_pill
               dvc commit train_pill
               dvc repro evaluate_pill
            else
               dvc repro train_pill 
            fi
          fi

          # === BOX PIPELINE ===
          if [[ "$TARGET" == "BOX" ]] || [[ "$TARGET" == "BOTH" ]]; then
            echo "üì¶ Processing BOX model..."
            if [[ "$MODE" == "INCREMENTAL" ]]; then
               dvc repro augment_box
               dvc commit train_box
               dvc repro evaluate_box
            else
               dvc repro train_box
            fi
          fi

      # --- 3. DEPLOYMENT PHASE ---
      - name: Deploy to S3
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          CLEAN_VERSION=$(echo $VERSION | sed 's/major-//' | sed 's/pill-//' | sed 's/box-//')
          
          echo "üöÄ Deploying version $CLEAN_VERSION..."
          
          python src/deploy.py \
            --version $CLEAN_VERSION \
            --path experiments/arcface_finetuned \
            --note "Deployed via System Python ($VERSION)"