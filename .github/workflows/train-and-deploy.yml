name: üíä PillTrack AI Pipeline (Self-Hosted GPU)

on:
  push:
    tags:
      - 'major-*'     # e.g., major-box-v1.0 (Full Train)
      - 'minor-*'     # e.g., minor-box-v1.1 (Incremental/Finetune)
      - 'pill-*'      # Generic pill tag
      - 'box-*'       # Generic box tag
  workflow_dispatch:  # ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏£‡∏±‡∏ô‡πÄ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ß‡πá‡∏ö

permissions:
  contents: write

jobs:
  train-and-deploy:
    name: üöÄ Training on RTX 5060 Ti
    # üî• ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ GPU
    runs-on: [self-hosted, linux, gpu]
    
    env:
      PYTHONUNBUFFERED: "1"
      # ‚úÖ Path ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏´‡πâ‡∏≤‡∏°‡∏ú‡∏¥‡∏î)
      REAL_PROJECT_PATH: "/home/admin-sitta/pilltrackMLops"
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      # 1. ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å GitHub
      - name: üì• Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Environment (‡πÉ‡∏ä‡πâ Conda ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
      - name: ‚öôÔ∏è Setup Environment (Conda & GPU)
        shell: bash
        run: |
          echo "üêç Activating Conda Environment..."
          # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Conda ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate pilltrack
          
          # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° GPU
          echo "============================================="
          echo "üñ•Ô∏è Running on Host: $(hostname)"
          echo "üî• GPU Status:"
          nvidia-smi
          echo "============================================="
          
          # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Library (‡πÉ‡∏ä‡πâ Mirror ‡πÑ‡∏ó‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß)
          pip install -r requirements.txt -i https://mirror.kku.ac.th/pypi/web/simple
          pip install "dvc[s3]>=3.0" python-dotenv

      # 3. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠)
      - name: üîó Link Real Data (Smart Link)
        run: |
          echo "üîó Linking data from $REAL_PROJECT_PATH/data"
          
          # ‡∏•‡∏ö folder data ‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÜ ‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏°‡∏≤‡∏Å‡∏±‡∏ö git (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          rm -rf data
          
          # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î (Symlink) ‡πÑ‡∏õ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
          if [ -d "$REAL_PROJECT_PATH/data" ]; then
            ln -sfn "$REAL_PROJECT_PATH/data" ./data
            echo "‚úÖ Data Linked Successfully!"
            ls -F data/
          else
            echo "‚ùå ERROR: Real data path not found at $REAL_PROJECT_PATH/data"
            exit 1
          fi

      # 4. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ AWS S3 (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö DVC)
      - name: ‚òÅÔ∏è Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      # 5. ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå DVC ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (DVC Pull)
      - name: üì• DVC Pull
        shell: bash
        run: |
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate pilltrack
          # ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ metrics ‡πÅ‡∏•‡∏∞ experiments ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
          dvc pull experiments/ metrics/ --force || echo "‚ö†Ô∏è No models on S3 yet, starting fresh."

      # 6. ‡∏£‡∏±‡∏ô Pipeline ‡∏´‡∏•‡∏±‡∏Å (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
      - name: ü§ñ Run AI Pipeline
        shell: bash
        run: |
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate pilltrack
          
          # ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠ Tag
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "üè∑Ô∏è Processing Tag: $TAG_NAME"
          
          # ---------------------------------------------------------
          # üì¶ BOX WORKFLOW
          # ---------------------------------------------------------
          if [[ "$TAG_NAME" =~ "box" ]]; then
            if [[ "$TAG_NAME" =~ "major" ]]; then
              echo "üî¥ Major Box: Full Training (Backbone + Head)..."
              # ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (Force CPU) -> Split -> Augment -> Train -> Eval
              dvc repro train_box -f
            else
              echo "üü¢ Minor Box: Incremental Learning (Head Only)..."
              # ‡∏Ç‡πâ‡∏≤‡∏° Training ‡πÉ‡∏´‡∏ç‡πà ‡πÑ‡∏õ Finetune ‡πÄ‡∏•‡∏¢
              dvc repro augment_box
              dvc commit train_box -f  # ‡∏´‡∏•‡∏≠‡∏Å DVC ‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡∏Ç‡πâ‡∏≤‡∏°)
              python src/finetune.py --type box
              dvc repro evaluate_box
            fi
          fi
          
          # ---------------------------------------------------------
          # üíä PILL WORKFLOW
          # ---------------------------------------------------------
          if [[ "$TAG_NAME" =~ "pill" ]]; then
            if [[ "$TAG_NAME" =~ "major" ]]; then
              echo "üî¥ Major Pill: Full Training..."
              dvc repro train_pill -f
            else
              echo "üü¢ Minor Pill: Incremental Learning..."
              dvc repro augment_pill
              dvc commit train_pill -f
              python src/finetune.py --type pill
              dvc repro evaluate_pill
            fi
          fi

      # 7. ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏∂‡πâ‡∏ô S3
      - name: üíæ Push Artifacts to S3
        if: success()
        run: |
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate pilltrack
          dvc push

      # 8. (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å) ‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà Project ‡∏à‡∏£‡∏¥‡∏á ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏î‡∏π‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
      - name: üîÑ Sync Results Back to Local Workspace
        if: always()
        run: |
          echo "üöÄ Syncing results back to: $REAL_PROJECT_PATH"
          
          # Copy experiments (Model Files)
          cp -r experiments "$REAL_PROJECT_PATH/" || true
          
          # Copy metrics (JSON Report)
          cp -r metrics "$REAL_PROJECT_PATH/" || true
          
          # Copy dvc.lock (State ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
          cp dvc.lock "$REAL_PROJECT_PATH/" || true
          
          echo "‚úÖ Sync Complete! Open VS Code to see results."

      # 9. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï dvc.lock ‡∏Ç‡∏∂‡πâ‡∏ô GitHub ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      - name: üì§ Git Commit DVC Lock
        if: success()
        run: |
          git config --local user.email "bot@pilltrack.ai"
          git config --local user.name "PillTrack Bot"
          
          git add dvc.lock
          # Commit ‡∏Ç‡πâ‡∏≤‡∏° CI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô Loop ‡∏ô‡∏£‡∏Å
          git commit -m "ü§ñ auto: update dvc lockfile [skip ci]" || echo "No changes to commit"
          git push origin HEAD:main || echo "Push failed (maybe conflicts), skipping..."