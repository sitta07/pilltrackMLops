name: üíä PillTrack AI Pipeline (RTX 5060 Ti Ultimate)

on:
  push:
    tags:
      - 'major-*'     # e.g., major-box-v1.0
      - 'minor-*'     # e.g., minor-box-v1.1
      - 'pill-*'
      - 'box-*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  train-and-deploy:
    name: üöÄ Training on Self-Hosted GPU
    runs-on: [self-hosted, linux, gpu]
    
    env:
      PYTHONUNBUFFERED: "1"
      REAL_PROJECT_PATH: "/home/admin-sitta/pilltrackMLops"
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # ----------------------------------------------------------------------
      # ‚öôÔ∏è SETUP ENVIRONMENT (OPTIMIZED & CLEANED)
      # ----------------------------------------------------------------------
      - name: ‚öôÔ∏è Setup Environment (RTX 5060 Ti / CUDA 12.8)
        shell: bash
        run: |
          echo "üêç Activating Conda Environment..."
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate pilltrack
          
          echo "üîç Checking existing PyTorch version..."
          if python -c "import torch; exit(0) if 'dev' in torch.__version__ and 'cu128' in torch.__version__ and torch.cuda.is_available() else exit(1)"; then
             echo "‚úÖ RTX 50 Ready! (Correct CUDA 12.8 version detected)"
             # ‡∏•‡∏ö lib ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö bg removal ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å req.txt ‡πÉ‡∏ô‡πÉ‡∏à (‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö manual)
             # pip install -r requirements.txt --no-deps <--- ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô txt ‡∏°‡∏µ rembg ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤
             # ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ install ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ requirements.txt ‡πÉ‡∏´‡πâ clean
             pip install "dvc[s3]>=3.0" python-dotenv
          else
             echo "üõë Wrong PyTorch version or old CUDA detected. Updating for RTX 50..."
             
             # 1. ‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ (‡πÄ‡∏≠‡∏≤ rembg, transparent-background ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÄ‡∏•‡∏¢)
             pip uninstall -y torch torchvision torchaudio timm kornia transparent-background rembg jsonschema onnxruntime-gpu || true
             
             # 2. ‡∏•‡∏á Library ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏•‡∏ö rembg ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å requirements.txt ‡πÉ‡∏ô repo ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥)
             # ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à‡πÅ‡∏Å‡πâ‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡πá‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ
             pip install -r requirements.txt
             pip install "dvc[s3]>=3.0" python-dotenv
             
             # 3. üî• ‡∏•‡∏á PyTorch Nightly ‡πÅ‡∏ö‡∏ö CUDA 12.8
             echo "‚¨áÔ∏è Installing PyTorch Nightly with CUDA 12.8 Support..."
             pip install --pre torch torchvision --index-url https://download.pytorch.org/whl/nightly/cu128 --no-deps
             
             # 4. ‡∏•‡∏á NVIDIA Libraries
             echo "üîß Installing latest NVIDIA libraries..."
             pip install nvidia-cuda-runtime-cu12 nvidia-cuda-nvrtc-cu12 \
                         nvidia-cusparselt-cu12 nvidia-cublas-cu12 \
                         nvidia-cudnn-cu12 nvidia-curand-cu12 \
                         nvidia-cufft-cu12 nvidia-nvjitlink-cu12 \
                         nvidia-nccl-cu12 nvidia-nvtx-cu12
          fi
          
          # --------------------------------------------------------------------
          # üî• GOD MODE LINKING
          # --------------------------------------------------------------------
          echo "üîó Linking NVIDIA Libraries..."
          SITE_PKG=$(python -c "import site; print(site.getsitepackages()[0])")
          find "$SITE_PKG/nvidia" -name "*.so*" -type f 2>/dev/null | while read -r lib_file; do
              lib_name=$(basename "$lib_file")
              ln -sf "$lib_file" "$CONDA_PREFIX/lib/$lib_name"
          done
          ln -sf $CONDA_PREFIX/lib/libcublas.so.12 $CONDA_PREFIX/lib/libcublas.so 2>/dev/null || true
          ln -sf $CONDA_PREFIX/lib/libcudart.so.12 $CONDA_PREFIX/lib/libcudart.so 2>/dev/null || true
          ln -sf $CONDA_PREFIX/lib/libcudnn.so.9 $CONDA_PREFIX/lib/libcudnn.so 2>/dev/null || true
          
          export LD_LIBRARY_PATH=$CONDA_PREFIX/lib:$LD_LIBRARY_PATH
          
          # Final Check
          python -c "import torch; print(f'üî• Torch Version: {torch.__version__}'); print(f'üî• GPU: {torch.cuda.get_device_name(0) if torch.cuda.is_available() else \"NOT AVAILABLE\"}');"

      # ----------------------------------------------------------------------
      # üîó DATA LINKING (THE BYPASS TRICK)
      # ----------------------------------------------------------------------
      - name: üîó Link Real Data & Bypass Preprocess
        run: |
          echo "üîó Linking inputs..."
          rm -rf data
          mkdir -p data/processed_box
          mkdir -p data/processed_pill
          
          if [ -d "$REAL_PROJECT_PATH/data/raw_box" ]; then
            # Link Raw
            ln -sfn "$REAL_PROJECT_PATH/data/raw_box" ./data/raw_box
            ln -sfn "$REAL_PROJECT_PATH/data/raw_pill" ./data/raw_pill
            
            # üî• BYPASS: Link Raw ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Processed ‡πÄ‡∏•‡∏¢ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡∏±‡∏î‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß)
            # ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏ä‡πá‡∏Ñ structure ‡∏î‡∏µ‡πÜ ‡∏ß‡πà‡∏≤ code ‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á path ‡πÑ‡∏´‡∏ô
            # ‡∏ñ‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ code ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å data/processed_box/images ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô ./data/processed_box/images
            ln -sfn "$REAL_PROJECT_PATH/data/raw_box" ./data/processed_box
            ln -sfn "$REAL_PROJECT_PATH/data/raw_pill" ./data/processed_pill
            
            echo "‚úÖ Data Setup Complete: Raw treated as Processed!"
          else
             echo "‚ùå Error: Raw data not found"
             exit 1
          fi

      - name: ‚òÅÔ∏è Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      - name: üì• DVC Pull
        shell: bash
        run: |
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate pilltrack
          dvc pull experiments/ metrics/ --force || echo "‚ö†Ô∏è No models on S3 yet, starting fresh."

      # ----------------------------------------------------------------------
      # ü§ñ RUN PIPELINE (SKIP PREPROCESS)
      # ----------------------------------------------------------------------
      - name: ü§ñ Run AI Pipeline (CUDA 12.8 Native)
        shell: bash
        run: |
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate pilltrack
          
          unset CUDA_MODULE_LOADING CUDA_FORCE_PTX_JIT TORCH_CUDNN_V8_API_ENABLED
          
          TAG_NAME=${GITHUB_REF#refs/tags/}
          
          # ‚ùå COMMENTED OUT PREPROCESS (User ‡∏ï‡∏±‡∏î‡∏°‡∏∑‡∏≠‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß)
          # if [[ "$TAG_NAME" =~ "box" ]]; then dvc repro preprocess_box -f; fi
          # if [[ "$TAG_NAME" =~ "pill" ]]; then dvc repro preprocess_pill -f; fi
          
          # Safety Net
          sed -i '/import torch/a torch.backends.cudnn.benchmark = False\ntorch.backends.cudnn.deterministic = True\ntorch.backends.cuda.matmul.allow_tf32 = True' src/train.py

          echo "üèéÔ∏è Enabling Blackwell (sm_120) Support..."
          export TORCH_CUDA_ARCH_LIST="10.0"
          export CUDA_MODULE_LOADING=LAZY
          export PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
          export LD_LIBRARY_PATH=$CONDA_PREFIX/lib:/usr/lib/wsl/lib:/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
          
          echo "üöÄ Starting Training..."
          
          # BOX PIPELINE
          if [[ "$TAG_NAME" =~ "box" ]]; then
            if [[ "$TAG_NAME" =~ "major" ]]; then
              # ‡∏Ç‡πâ‡∏≤‡∏° preprocess ‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å train ‡πÄ‡∏•‡∏¢
              # ‡∏ñ‡πâ‡∏≤ DVC ‡∏á‡∏≠‡πÅ‡∏á‡∏ß‡πà‡∏≤‡∏´‡∏≤ preprocess ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ python src/train.py ‡πÅ‡∏ó‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ dvc run -f
              dvc repro train_box --force
            else
              dvc repro augment_box
              dvc commit train_box -f 
              python src/finetune.py --type box
              dvc repro evaluate_box
            fi
          fi
          
          # PILL PIPELINE
          if [[ "$TAG_NAME" =~ "pill" ]]; then
            if [[ "$TAG_NAME" =~ "major" ]]; then
              dvc repro train_pill --force
            else
              dvc repro augment_pill
              dvc commit train_pill -f
              python src/finetune.py --type pill
              dvc repro evaluate_pill
            fi
          fi

      - name: üíæ Push Artifacts
        if: success()
        run: |
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate pilltrack
          dvc push

      - name: üîÑ Sync Results Back
        if: always()
        run: |
          cp -r experiments "$REAL_PROJECT_PATH/" || true
          cp -r metrics "$REAL_PROJECT_PATH/" || true
          cp dvc.lock "$REAL_PROJECT_PATH/" || true
          # Sync ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà processed folder (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠ augment)
          mkdir -p "$REAL_PROJECT_PATH/data/processed_box"
          mkdir -p "$REAL_PROJECT_PATH/data/processed_pill"
          if [ -d "data/processed_box" ]; then cp -ru data/processed_box/* "$REAL_PROJECT_PATH/data/processed_box/" || true; fi
          if [ -d "data/processed_pill" ]; then cp -ru data/processed_pill/* "$REAL_PROJECT_PATH/data/processed_pill/" || true; fi

      - name: üì§ Git Commit DVC Lock
        if: success()
        run: |
          git config --local user.email "bot@pilltrack.ai"
          git config --local user.name "PillTrack Bot"
          git add dvc.lock
          git commit -m "ü§ñ auto: update dvc lockfile [skip ci]" || echo "No changes to commit"
          git push origin HEAD:main || echo "Push failed (maybe conflicts), skipping..."