name: üíä PillTrack AI Pipeline (RTX 5060 Ti Ultimate)

on:
  push:
    tags:
      - 'major-*'     # e.g., major-box-v1.0
      - 'minor-*'     # e.g., minor-box-v1.1
      - 'pill-*'
      - 'box-*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  train-and-deploy:
    name: üöÄ Training on Self-Hosted GPU
    runs-on: [self-hosted, linux, gpu]
    
    env:
      PYTHONUNBUFFERED: "1"
      # ‚úÖ Path ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      REAL_PROJECT_PATH: "/home/admin-sitta/pilltrackMLops"
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      # 1. ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å GitHub
      - name: üì• Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Environment (RTX 50 Fix + God Mode Libraries)
      - name: ‚öôÔ∏è Setup Environment (RTX 5060 Ti Ready)
        shell: bash
        run: |
          echo "üêç Activating Conda Environment..."
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate pilltrack
          
          echo "üîç Checking existing PyTorch version..."
          
          # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Torch Nightly ('dev') ‡πÅ‡∏•‡∏∞‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô GPU ‡πÑ‡∏´‡∏°?
          if python -c "import torch; exit(0) if 'dev' in torch.__version__ and torch.cuda.is_available() else exit(1)"; then
             # ‚úÖ CASE A: ‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (Fast Lane)
             echo "‚úÖ RTX 50 Ready! (Torch Nightly detected)"
             echo "‚è© Skipping heavy installation..."
             
             # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏Ñ‡πà requirements ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
             pip install -r requirements.txt --no-deps
             pip install "dvc[s3]>=3.0" python-dotenv
             
             # üî• Ensure NVIDIA Runtime is present (‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß)
             echo "üîß Ensuring NVIDIA Runtime..."
             pip install nvidia-cuda-runtime-cu12 nvidia-cuda-nvrtc-cu12
             
          else
             # üõë CASE B: ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (Full Install)
             echo "üõë Environment needs update for RTX 5060 Ti..."
             echo "üöÄ Starting Fresh Install (The Sandwich Strategy)..."
             
             # 1. ‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤
             pip uninstall -y torch torchvision torchaudio timm kornia transparent-background rembg jsonschema onnxruntime-gpu || true
             
             # 2. ‡∏•‡∏á Library ‡∏õ‡∏Å‡∏ï‡∏¥
             pip install -r requirements.txt
             pip install "dvc[s3]>=3.0" python-dotenv
             
             # 3. üî• ‡∏™‡∏≠‡∏î‡πÑ‡∏™‡πâ RTX 50 Engine (Nightly Swap with Architecture Support)
             echo "üîÑ Swapping to Nightly Build with RTX 50 Support..."
             pip uninstall -y torch torchvision torchaudio
             
             # Install PyTorch Nightly with CUDA 12.4
             pip install --pre torch torchvision --index-url https://download.pytorch.org/whl/nightly/cu124 --no-deps
             
             # üî• GOD MODE INSTALL: ‡∏•‡∏á‡πÅ‡∏°‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á NVIDIA
             echo "üîß Installing ALL NVIDIA libraries..."
             pip install nvidia-cuda-runtime-cu12 nvidia-cuda-nvrtc-cu12 \
                         nvidia-cusparselt-cu12 nvidia-cublas-cu12 \
                         nvidia-cudnn-cu12 nvidia-curand-cu12 \
                         nvidia-cufft-cu12 nvidia-nvjitlink-cu12 \
                         nvidia-nccl-cu12 nvidia-nvtx-cu12
          fi
          
          # --------------------------------------------------------------------
          # üî• GOD MODE LINKING: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå .so ‡πÄ‡∏Ç‡πâ‡∏≤ System
          # --------------------------------------------------------------------
          echo "üîó Linking ALL NVIDIA Libraries (God Mode)..."
          SITE_PKG=$(python -c "import site; print(site.getsitepackages()[0])")
          
          # ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå .so ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô folder nvidia ‡πÅ‡∏•‡πâ‡∏ß link ‡πÄ‡∏Ç‡πâ‡∏≤ conda lib
          find "$SITE_PKG/nvidia" -name "*.so*" -type f 2>/dev/null | while read -r lib_file; do
              lib_name=$(basename "$lib_file")
              ln -sf "$lib_file" "$CONDA_PREFIX/lib/$lib_name"
          done
          
          # Link ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ version number ‡∏¢‡πà‡∏≠‡∏¢ (‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß)
          ln -sf $CONDA_PREFIX/lib/libcublas.so.12 $CONDA_PREFIX/lib/libcublas.so 2>/dev/null || true
          ln -sf $CONDA_PREFIX/lib/libcudart.so.12 $CONDA_PREFIX/lib/libcudart.so 2>/dev/null || true
          ln -sf $CONDA_PREFIX/lib/libcudnn.so.9 $CONDA_PREFIX/lib/libcudnn.so 2>/dev/null || true
          
          # üî• EXPORT LD_LIBRARY_PATH (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PyTorch)
          export LD_LIBRARY_PATH=$CONDA_PREFIX/lib:$LD_LIBRARY_PATH
          
          echo "‚úÖ All Libraries Linked (God Mode Complete)!"
          
          # Final Check with Compute Capability
          python -c "import torch; print(f'üî• Torch: {torch.__version__}'); print(f'GPU: {torch.cuda.get_device_name(0) if torch.cuda.is_available() else \"NOT AVAILABLE\"}');"

      # 3. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
      - name: üîó Link Real Data (Input Only)
        run: |
          echo "üîó Linking inputs only..."
          rm -rf data
          mkdir -p data
          if [ -d "$REAL_PROJECT_PATH/data/raw_box" ]; then
            ln -sfn "$REAL_PROJECT_PATH/data/raw_box" ./data/raw_box
            ln -sfn "$REAL_PROJECT_PATH/data/raw_pill" ./data/raw_pill
            echo "‚úÖ Input Data Linked Successfully!"
          else
             echo "‚ùå Error: Raw data not found at $REAL_PROJECT_PATH/data"
             exit 1
          fi

      # 4. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ AWS S3
      - name: ‚òÅÔ∏è Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      # 5. ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå DVC
      - name: üì• DVC Pull
        shell: bash
        run: |
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate pilltrack
          dvc pull experiments/ metrics/ --force || echo "‚ö†Ô∏è No models on S3 yet, starting fresh."

      # 6. ‡∏£‡∏±‡∏ô Pipeline ‡∏´‡∏•‡∏±‡∏Å (RTX 5060 Ti COMPATIBILITY MODE)
      - name: ü§ñ Run AI Pipeline (RTX 5060 Ti Mode)
        shell: bash
        run: |
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate pilltrack
          
          # ====================================================================
          # üè• PHASE 1: PREPROCESS (CLEAN ENV) - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö rembg/ONNX
          # ====================================================================
          # rembg ‡πÑ‡∏°‡πà‡∏ä‡∏≠‡∏ö Env Var ‡∏û‡∏ß‡∏Å‡∏ô‡∏µ‡πâ ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô Error CUDNN
          unset CUDA_MODULE_LOADING CUDA_FORCE_PTX_JIT TORCH_CUDNN_V8_API_ENABLED NCCL_P2P_DISABLE TORCH_USE_CUDA_DSA TORCH_CUDA_ARCH_LIST
          
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "üßπ [PHASE 1] Starting Preprocess Phase (Clean Env) for tag: $TAG_NAME"
          
          if [[ "$TAG_NAME" =~ "box" ]]; then
              echo "üì¶ Preprocessing BOX data..."
              dvc repro preprocess_box -f
          fi
          
          if [[ "$TAG_NAME" =~ "pill" ]]; then
              echo "üíä Preprocessing PILL data..."
              dvc repro preprocess_pill -f
          fi
          
          # ====================================================================
          # üíâ CODE INJECTION (Train Stability)
          # ====================================================================
          echo "üíâ Injecting safety code into src/train.py..."
          sed -i '/import torch/a torch.backends.cudnn.benchmark = False\ntorch.backends.cudnn.deterministic = True\ntorch.backends.cuda.matmul.allow_tf32 = True\ntorch.backends.cudnn.allow_tf32 = True' src/train.py

          # ====================================================================
          # üöÄ PHASE 2: TRAINING (RTX 5060 Ti COMPATIBILITY MODE)
          # ====================================================================
          echo "üèéÔ∏è [PHASE 2] Enabling RTX 5060 Ti Compatibility Mode..."
          
          # üî• RTX 50 Series (Blackwell) Environment Variables
          export CUDA_MODULE_LOADING=LAZY                      # Lazy load CUDA modules (fix kernel not found)
          export CUDA_FORCE_PTX_JIT=1                          # Force JIT compilation
          export TORCH_USE_CUDA_DSA=1                          # Enable assertions
          export TORCH_CUDA_ARCH_LIST="10.0"                   # RTX 5060 Ti architecture
          export PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
          export TORCH_CUDNN_V8_API_ENABLED=1
          export NCCL_P2P_DISABLE=1
          
          # Library paths (Critical)
          export LD_LIBRARY_PATH=$CONDA_PREFIX/lib:/usr/lib/wsl/lib:/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
          
          # Performance opts
          export TORCH_ALLOW_TF32_CUBLAS_OVERRIDE=1
          export CUDA_DEVICE_MAX_CONNECTIONS=1
          
          # ====================================================================
          # üîç GPU VERIFICATION LOG (‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ó‡∏£‡∏ô)
          # ====================================================================
          echo "üîç Verifying GPU and CUDA Setup..."
          python -c "
          import torch
          print('-' * 40)
          print(f'üî• PyTorch Version: {torch.__version__}')
          print(f'üî• CUDA Available:  {torch.cuda.is_available()}')
          if torch.cuda.is_available():
              print(f'üî• GPU Name:        {torch.cuda.get_device_name(0)}')
              cc = torch.cuda.get_device_capability(0)
              print(f'üî• Compute Cap:     {cc[0]}.{cc[1]}')
              print(f'üî• CUDA Version:    {torch.version.cuda}')
              if cc[0] >= 10:
                  print('üöÄ RTX 50 Series Detected - JIT Compilation Enabled!')
          else:
              print('‚ùå CUDA not available! Something is wrong.')
              exit(1)
          print('-' * 40)
          "
          
          echo "üöÄ Starting Training Loop with RTX 5060 Ti optimization..."
          
          if [[ "$TAG_NAME" =~ "box" ]]; then
            if [[ "$TAG_NAME" =~ "major" ]]; then
              echo "üî¥ Major Box: Full Training..."
              dvc repro train_box
            else
              echo "üü¢ Minor Box: Incremental Learning..."
              dvc repro augment_box
              dvc commit train_box -f 
              python src/finetune.py --type box
              dvc repro evaluate_box
            fi
          fi
          
          if [[ "$TAG_NAME" =~ "pill" ]]; then
            if [[ "$TAG_NAME" =~ "major" ]]; then
              echo "üî¥ Major Pill: Full Training..."
              dvc repro train_pill
            else
              echo "üü¢ Minor Pill: Incremental Learning..."
              dvc repro augment_pill
              dvc commit train_pill -f
              python src/finetune.py --type pill
              dvc repro evaluate_pill
            fi
          fi
          
          echo "‚úÖ Training Complete!"

      # 7. ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏∂‡πâ‡∏ô S3
      - name: üíæ Push Artifacts to S3
        if: success()
        run: |
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate pilltrack
          dvc push

      # 8. Sync ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
      - name: üîÑ Sync Results Back to Local Workspace
        if: always()
        run: |
          echo "üöÄ Syncing results back to: $REAL_PROJECT_PATH"
          cp -r experiments "$REAL_PROJECT_PATH/" || true
          cp -r metrics "$REAL_PROJECT_PATH/" || true
          cp dvc.lock "$REAL_PROJECT_PATH/" || true
          
          echo "üì∏ Syncing processed images..."
          mkdir -p "$REAL_PROJECT_PATH/data/processed_box"
          mkdir -p "$REAL_PROJECT_PATH/data/processed_pill"
          
          if [ -d "data/processed_box" ]; then
            cp -ru data/processed_box/* "$REAL_PROJECT_PATH/data/processed_box/" || true
          fi
          if [ -d "data/processed_pill" ]; then
            cp -ru data/processed_pill/* "$REAL_PROJECT_PATH/data/processed_pill/" || true
          fi
          
          echo "‚úÖ Sync Complete! Open VS Code to see your images."

      # 9. Update dvc.lock ‡∏ö‡∏ô GitHub
      - name: üì§ Git Commit DVC Lock
        if: success()
        run: |
          git config --local user.email "bot@pilltrack.ai"
          git config --local user.name "PillTrack Bot"
          git add dvc.lock
          git commit -m "ü§ñ auto: update dvc lockfile [skip ci]" || echo "No changes to commit"
          git push origin HEAD:main || echo "Push failed (maybe conflicts), skipping..."