name: PillTrack MLOps Pipeline üíä

on:
  push:
    tags:
      - 'v*'          # Catch all tags starting with v
      - 'pill-v*'     # Specific for Pill
      - 'box-v*'      # Specific for Box
      - 'major-*'     # Catch all major updates

jobs:
  train-and-deploy:
    name: Smart Training Pipeline
    runs-on: self-hosted
    
    steps:
      # --- 1. SETUP PHASE (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install dvc[s3] python-dotenv

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: DVC Pull Data
        run: |
          dvc remote modify myremote --local access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          dvc remote modify myremote --local secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          dvc pull
          # ‚ö†Ô∏è ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏•‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏ó‡∏£‡∏ô ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°

      # --- 2. üß† THE BRAIN: LOGIC ‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ---
      - name: Analyze Tag & Execute Pipeline
        run: |
          # ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ refs/tags/ ‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏ä‡∏∑‡πà‡∏≠ Tag
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "üè∑Ô∏è Detected Tag: $TAG_NAME"

          # 1. Check Mode (Major vs Incremental)
          if [[ "$TAG_NAME" == *"major"* ]]; then
            MODE="FULL"
            echo "üî• Mode: FULL RETRAINING (Major Update)"
          else
            MODE="INCREMENTAL"
            echo "‚ö° Mode: INCREMENTAL UPDATE (Fast Track)"
          fi

          # 2. Check Target (Pill vs Box vs Both)
          if [[ "$TAG_NAME" == *"pill"* ]]; then
            TARGET="PILL"
            echo "üéØ Target: PILL ONLY"
          elif [[ "$TAG_NAME" == *"box"* ]]; then
            TARGET="BOX"
            echo "üéØ Target: BOX ONLY"
          else
            TARGET="BOTH"
            echo "üéØ Target: BOTH (Pill & Box)"
          fi

          echo "----------------------------------------"

          # 3. EXECUTION LOGIC
          
          # === PILL PIPELINE ===
          if [[ "$TARGET" == "PILL" ]] || [[ "$TARGET" == "BOTH" ]]; then
            echo "üíä Processing PILL model..."
            if [[ "$MODE" == "INCREMENTAL" ]]; then
               dvc repro augment_pill
               dvc commit train_pill
               dvc repro evaluate_pill
            else
               dvc repro train_pill # Full chain
            fi
          else
            echo "‚è© Skipping PILL model..."
          fi

          # === BOX PIPELINE ===
          if [[ "$TARGET" == "BOX" ]] || [[ "$TARGET" == "BOTH" ]]; then
            echo "üì¶ Processing BOX model..."
            if [[ "$MODE" == "INCREMENTAL" ]]; then
               dvc repro augment_box
               dvc commit train_box
               dvc repro evaluate_box
            else
               dvc repro train_box # Full chain
            fi
          else
             echo "‚è© Skipping BOX model..."
          fi

      # --- 3. DEPLOYMENT PHASE ---
      - name: Deploy to S3
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          
          # Clean version name for folder (remove prefixes)
          CLEAN_VERSION=$(echo $VERSION | sed 's/major-//' | sed 's/pill-//' | sed 's/box-//')
          
          echo "üöÄ Deploying version $CLEAN_VERSION..."
          
          # Deploy Script ‡∏à‡∏∞‡πÑ‡∏õ‡∏Å‡∏ß‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á Pill ‡πÅ‡∏•‡∏∞ Box
          # (‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡∏°‡πà + ‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å dvc pull)
          python src/deploy.py \
            --version $CLEAN_VERSION \
            --path experiments/arcface_finetuned \
            --note "Automated Deploy: $VERSION"