name: PillTrack MLOps Pipeline üíä

on:
  push:
    tags:
      - 'v*'          # ‡πÅ‡∏ó‡πá‡∏Å‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
      - 'pill-*'      # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≤‡πÄ‡∏°‡πá‡∏î‡πÉ‡∏´‡∏°‡πà (Incremental)
      - 'box-*'       # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≤‡πÉ‡∏´‡∏°‡πà (Incremental)
      - 'major-pill-*' # ‡πÄ‡∏ó‡∏£‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏¢‡∏≤‡πÄ‡∏°‡πá‡∏î (Major Update)
      - 'major-box-*'  # ‡πÄ‡∏ó‡∏£‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≤ (Major Update)

jobs:
  train-and-deploy:
    name: Smart Training Pipeline
    runs-on: self-hosted
    env:
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # ‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ó‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Project ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏µ‡πà ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà Runner Workspace
      - name: üîó Link Local Dataset to Runner
        run: |
          echo "üîó Linking local images to runner's workspace..."
          mkdir -p data
          # ‡∏•‡∏ö‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏µ‡πà
          ln -sfn /Users/sittasahathum/Desktop/pilltrackMLops/data/raw_box ./data/raw_box
          ln -sfn /Users/sittasahathum/Desktop/pilltrackMLops/data/raw_pill ./data/raw_pill
          echo "‚úÖ Dataset linked from: /Users/sittasahathum/Desktop/pilltrackMLops/data/"

      - name: Setup Venv & Dependencies
        run: |
          if [ ! -d "venv" ]; then /opt/homebrew/bin/python3.10 -m venv venv; fi
          echo "$PWD/venv/bin" >> $GITHUB_PATH
          pip install -r requirements.txt
          pip install "dvc[s3]>=3.0" python-dotenv transparent-background

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ‚úÖ ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Model ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å S3 (‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ Manual Step 3)
      - name: DVC Pull Models
        run: |
          dvc remote modify myremote --local access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          dvc remote modify myremote --local secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          echo "üì• Pulling models from S3..."
          # ‡πÉ‡∏ä‡πâ --force ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô Workspace
          dvc pull experiments/ metrics/ --force || echo "‚ö†Ô∏è No models found on S3, starting fresh."

      # ‚öôÔ∏è Logic ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏° Manual Workflows (BOX & PILL)
      - name: Run Pipeline based on Manual Guide
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "üè∑Ô∏è Tag detected: $TAG_NAME"

          # === üì¶ BOX LOGIC ===
          if [[ "$TAG_NAME" =~ "box" ]]; then
            if [[ "$TAG_NAME" =~ "major" ]]; then
              echo "üî¥ Mode: BOX Major Update (Full Train)"
              dvc repro train_box -f
            else
              echo "üü¢ Mode: BOX Incremental Update"
              dvc repro augment_box  # 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
              dvc commit train_box   # 2. ‡∏•‡πá‡∏≠‡∏Ñ Base Model
              dvc repro evaluate_box # 3. Finetune & Evaluate
            fi
          fi

          # === üíä PILL LOGIC ===
          if [[ "$TAG_NAME" =~ "pill" ]]; then
            if [[ "$TAG_NAME" =~ "major" ]]; then
              echo "üî¥ Mode: PILL Major Update (Full Train)"
              dvc repro train_pill -f
            else
              echo "üü¢ Mode: PILL Incremental Update"
              dvc repro augment_pill  # 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
              dvc commit train_pill   # 2. ‡∏•‡πá‡∏≠‡∏Ñ Base Model
              dvc repro evaluate_pill # 3. Finetune & Evaluate
            fi
          fi

      # ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏á‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô Cloud (Manual Step 3)
      # ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: dvc push ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á push: false ‡πÉ‡∏ô dvc.yaml
      - name: Push Artifacts to DVC
        run: |
          echo "‚òÅÔ∏è Uploading Models & Metrics to S3..."
          dvc push

      # üöÄ Production Deployment (Manual Step 4)
      - name: Deploy to S3 Releases
        run: |
          CLEAN_VER=$(echo $TAG_NAME | sed 's/major-//' | sed 's/pill-//' | sed 's/box-//')
          # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Path ‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î (Major=Base, Normal=Finetuned)
          if [[ "$TAG_NAME" =~ "major" ]]; then PATH_TYPE="arcface_lite_v1"; else PATH_TYPE="arcface_finetuned"; fi
          
          python src/deploy.py \
            --version "$CLEAN_VER" \
            --path "experiments/$PATH_TYPE" \
            --note "Auto-deployed via CI/CD for $TAG_NAME"