name: PillTrack MLOps Pipeline üíä

on:
  push:
    tags:
      - 'v*'
      - 'pill-*'
      - 'box-*'
      - 'major-*'

jobs:
  train-and-deploy:
    name: Smart Training Pipeline
    runs-on: self-hosted
    
    env:
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup System Python & Venv
        run: |
          if [ ! -d "venv" ]; then
            /opt/homebrew/bin/python3.10 -m venv venv
          fi
          echo "$PWD/venv/bin" >> $GITHUB_PATH

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install "dvc[s3]>=3.0" python-dotenv transparent-background

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Nuke Cache
        run: |
          echo "üí£ Cleaning up old DVC cache..."
          rm -rf .dvc/cache .dvc/tmp

      # ‚úÖ Senior Fix: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏• ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡πÄ‡∏ó‡∏£‡∏ô‡πÉ‡∏´‡∏°‡πà/‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)
      - name: DVC Pull Models Only
        run: |
          dvc remote modify myremote --local access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          dvc remote modify myremote --local secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          echo "üì• Attempting to pull models (Allowed to fail if missing on S3)..."
          # ‡πÉ‡∏ä‡πâ || true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ CI ‡∏û‡∏±‡∏á‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô S3 ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
          dvc pull experiments/ metrics/ --force || echo "‚ö†Ô∏è Some models missing on S3, using local versions."

      - name: Run Pipeline
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "üè∑Ô∏è Tag Selected: $TAG_NAME"

          # 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î (Full Train vs Incremental)
          if [[ "$TAG_NAME" =~ "major" ]]; then MODE="FULL"; else MODE="INCREMENTAL"; fi
          
          # 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Pill vs Box)
          if [[ "$TAG_NAME" =~ "pill" ]]; then TARGET="PILL";
          elif [[ "$TAG_NAME" =~ "box" ]]; then TARGET="BOX";
          else TARGET="BOTH"; fi

          # ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ Git state ‡∏Ç‡∏≠‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
          git rm -r --cached experiments/ || true

          # === üì¶ BOX EXECUTION ===
          if [[ "$TARGET" == "BOX" ]] || [[ "$TARGET" == "BOTH" ]]; then
            echo "üì¶ Processing BOX Model..."
            if [[ "$MODE" == "FULL" ]]; then
               # ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏´‡∏°‡∏î (‡πÉ‡∏ä‡πâ Data ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏µ‡πà)
               dvc repro evaluate_base_box -f
            else
               dvc repro augment_box
               echo "‚è© Skipping Base Train..."
               dvc commit train_box
               dvc repro evaluate_box
            fi
          fi

          # === üíä PILL EXECUTION ===
          if [[ "$TARGET" == "PILL" ]] || [[ "$TARGET" == "BOTH" ]]; then
            echo "üíä Processing PILL Model..."
            if [[ "$MODE" == "FULL" ]]; then
               dvc repro evaluate_base_pill -f
            else
               dvc repro augment_pill
               echo "‚è© Skipping Base Train..."
               dvc commit train_pill
               dvc repro evaluate_pill
            fi
          fi

      # ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Model & Metrics ‡∏Ç‡∏∂‡πâ‡∏ô S3 (Dataset ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏µ‡πà)
      - name: Push Artifacts to DVC Remote
        run: |
          echo "‚òÅÔ∏è Uploading Models & Metrics to S3..."
          dvc push experiments/ metrics/

      - name: Deploy to Production S3
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          CLEAN_VERSION=$(echo $VERSION | sed 's/major-//' | sed 's/pill-//' | sed 's/box-//')
          BUCKET="${{ secrets.S3_BUCKET_NAME }}"
          
          if [[ "$VERSION" =~ "major" ]]; then
             BASE_PATH="experiments/arcface_lite_v1"
          else
             BASE_PATH="experiments/arcface_finetuned"
          fi
          
          if [ -d "$BASE_PATH/box" ]; then
            python src/deploy.py --version "$CLEAN_VERSION" --path "$BASE_PATH" --type box --bucket "$BUCKET"
          fi
          if [ -d "$BASE_PATH/pill" ]; then
            python src/deploy.py --version "$CLEAN_VERSION" --path "$BASE_PATH" --type pill --bucket "$BUCKET"
          fi