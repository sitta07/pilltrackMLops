name: PillTrack MLOps Pipeline üíä

on:
  push:
    tags:
      - 'v*'
      - 'pill-*'
      - 'box-*'
      - 'major-pill-*'
      - 'major-box-*'

jobs:
  train-and-deploy:
    name: Smart Training Pipeline
    runs-on: self-hosted
    env:
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # ‚úÖ 1. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ó‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å (MacBook) ‡πÄ‡∏Ç‡πâ‡∏≤ Runner Workspace
      - name: üîó Link Local Dataset to Runner
        run: |
          echo "üîó Linking local images..."
          mkdir -p data
          # ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Path ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏µ‡πà
          ln -sfn /Users/sittasahathum/Desktop/pilltrackMLops/data/raw_box ./data/raw_box
          ln -sfn /Users/sittasahathum/Desktop/pilltrackMLops/data/raw_pill ./data/raw_pill
          echo "‚úÖ Dataset linked!"

      - name: Setup Venv
        run: |
          if [ ! -d "venv" ]; then /opt/homebrew/bin/python3.10 -m venv venv; fi
          echo "$PWD/venv/bin" >> $GITHUB_PATH

      # ‚úÖ 2. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Library (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠ Pillow ‡πÅ‡∏•‡∏∞ transparent-background)
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install Pillow transparent-background
          pip install -r requirements.txt
          pip install "dvc[s3]>=3.0" python-dotenv

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ‚úÖ 3. ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Model ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°)
      - name: DVC Pull Models
        run: |
          dvc remote modify myremote --local access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          dvc remote modify myremote --local secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          echo "üì• Pulling models from S3..."
          dvc pull experiments/ metrics/ --force || echo "‚ö†Ô∏è No models on S3 yet."

      # ‚úÖ 4. ‡∏£‡∏±‡∏ô Pipeline ‡∏ï‡∏≤‡∏° Logic ‡∏Ç‡∏≠‡∏á Senior (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á Manual Guide ‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà)
      - name: Run Pipeline
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "üè∑Ô∏è Running: $TAG_NAME"

          # ‡πÅ‡∏¢‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á BOX ‡πÅ‡∏•‡∏∞ PILL
          if [[ "$TAG_NAME" =~ "box" ]]; then
            if [[ "$TAG_NAME" =~ "major" ]]; then
              echo "üî¥ Mode: BOX Major Update"
              dvc repro train_box -f
            else
              echo "üü¢ Mode: BOX Incremental Update"
              dvc repro augment_box && dvc commit train_box && dvc repro evaluate_box
            fi
          fi

          if [[ "$TAG_NAME" =~ "pill" ]]; then
            if [[ "$TAG_NAME" =~ "major" ]]; then
              echo "üî¥ Mode: PILL Major Update"
              dvc repro train_pill -f
            else
              echo "üü¢ Mode: PILL Incremental Update"
              dvc repro augment_pill && dvc commit train_pill && dvc repro evaluate_pill
            fi
          fi

      # ‚úÖ 5. ‡πÄ‡∏Å‡πá‡∏ö‡∏á‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô S3 (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Model/Metrics ‡∏ï‡∏≤‡∏° dvc.yaml)
      - name: Push Artifacts
        run: |
          echo "‚òÅÔ∏è Uploading Models to S3..."
          dvc push

      # ‚úÖ 6. Deploy ‡∏•‡∏á‡∏ñ‡∏±‡∏á Release (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° --bucket ‡πÅ‡∏•‡∏∞ --type)
      - name: Deploy to S3 Releases
        run: |
          # ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠ Version ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô
          CLEAN_VER=$(echo $TAG_NAME | sed 's/major-//' | sed 's/pill-//' | sed 's/box-//')
          
          if [[ "$TAG_NAME" =~ "major" ]]; then 
            PATH_TYPE="arcface_lite_v1"
          else 
            PATH_TYPE="arcface_finetuned"
          fi

          if [[ "$TAG_NAME" =~ "pill" ]]; then 
            MODEL_TYPE="pill"
          else 
            MODEL_TYPE="box"
          fi
          
          echo "üöÄ Deploying $MODEL_TYPE model version $CLEAN_VER..."
          python src/deploy.py \
            --version "$CLEAN_VER" \
            --path "experiments/$PATH_TYPE" \
            --type "$MODEL_TYPE" \
            --bucket "${{ secrets.S3_BUCKET_NAME }}" \
            --note "Auto-deployed for $TAG_NAME via GitHub Actions"