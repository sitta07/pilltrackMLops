name: üíä PillTrack AI Pipeline (RTX 5060 Ti Optimized)

on:
  push:
    tags:
      - 'major-*'     # e.g., major-box-v1.0
      - 'minor-*'     # e.g., minor-box-v1.1
      - 'pill-*'
      - 'box-*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  train-and-deploy:
    name: üöÄ Training on Self-Hosted GPU
    runs-on: [self-hosted, linux, gpu]
    
    env:
      PYTHONUNBUFFERED: "1"
      REAL_PROJECT_PATH: "/home/admin-sitta/pilltrackMLops"
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # ------------------------------------------------------------------
      # üî• HERO FIX: ‡∏™‡∏•‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á (The Sandwich Strategy)
      # 1. ‡∏•‡∏á Requirements ‡∏õ‡∏Å‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô (‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ Torch Stable)
      # 2. ‡∏•‡∏ö Torch Stable ‡∏ó‡∏¥‡πâ‡∏á
      # 3. ‡∏•‡∏á Torch Nightly ‡∏ó‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏õ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ RTX 50 ‡πÑ‡∏î‡πâ)
      # ------------------------------------------------------------------
      - name: ‚öôÔ∏è Setup Environment (Dependency Swap Fix)
        shell: bash
        run: |
          echo "üêç Activating Conda Environment..."
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate pilltrack
          
          echo "üì¶ Phase 1: Installing Standard Dependencies..."
          # ‡∏•‡∏á libs ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô (‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡∏•‡∏á torch ‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô)
          pip install -r requirements.txt -i https://mirror.kku.ac.th/pypi/web/simple
          pip install "dvc[s3]>=3.0" python-dotenv
          
          echo "üîÑ Phase 2: Swapping Engine to RTX 50 (Nightly)..."
          # ‡∏•‡∏ö torch ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á
          pip uninstall -y torch torchvision torchaudio
          
          # ‡∏•‡∏á Nightly ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà (Index URL ‡∏û‡∏¥‡πÄ‡∏®‡∏©)
          echo "‚¨áÔ∏è Installing Torch Nightly..."
          pip install --pre torch torchvision --index-url https://download.pytorch.org/whl/nightly/cu124
          
          # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡∏≠‡∏á (‡πÅ‡∏Å‡πâ Syntax Error ‡πÅ‡∏•‡πâ‡∏ß)
          python -c "import torch; print(f'üî• Torch: {torch.__version__}, CUDA: {torch.version.cuda}, GPU: {torch.cuda.get_device_name(0) if torch.cuda.is_available() else None}')"

      - name: üîó Link Real Data
        run: |
          echo "üîó Linking data from $REAL_PROJECT_PATH/data"
          rm -rf data
          if [ -d "$REAL_PROJECT_PATH/data" ]; then
            ln -sfn "$REAL_PROJECT_PATH/data" ./data
            echo "‚úÖ Data Linked Successfully!"
            ls -F data/
          else
            echo "‚ùå ERROR: Real data path not found at $REAL_PROJECT_PATH/data"
            exit 1
          fi

      - name: ‚òÅÔ∏è Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      - name: üì• DVC Pull
        shell: bash
        run: |
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate pilltrack
          dvc pull experiments/ metrics/ --force || echo "‚ö†Ô∏è No models on S3 yet, starting fresh."

      - name: ü§ñ Run AI Pipeline (GPU Accelerated)
        shell: bash
        run: |
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate pilltrack
          
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "üè∑Ô∏è Processing Tag: $TAG_NAME"
          
          # --- BOX WORKFLOW ---
          if [[ "$TAG_NAME" =~ "box" ]]; then
            if [[ "$TAG_NAME" =~ "major" ]]; then
              echo "üî¥ Major Box: Full Training..."
              dvc repro train_box -f
            else
              echo "üü¢ Minor Box: Incremental Learning..."
              dvc repro augment_box
              dvc commit train_box -f 
              python src/finetune.py --type box
              dvc repro evaluate_box
            fi
          fi
          
          # --- PILL WORKFLOW ---
          if [[ "$TAG_NAME" =~ "pill" ]]; then
            if [[ "$TAG_NAME" =~ "major" ]]; then
              echo "üî¥ Major Pill: Full Training..."
              dvc repro train_pill -f
            else
              echo "üü¢ Minor Pill: Incremental Learning..."
              dvc repro augment_pill
              dvc commit train_pill -f
              python src/finetune.py --type pill
              dvc repro evaluate_pill
            fi
          fi

      - name: üíæ Push Artifacts to S3
        if: success()
        run: |
          source ~/miniconda3/etc/profile.d/conda.sh
          conda activate pilltrack
          dvc push

      - name: üîÑ Sync Results Back to Local Workspace
        if: always()
        run: |
          echo "üöÄ Syncing results back to: $REAL_PROJECT_PATH"
          cp -r experiments "$REAL_PROJECT_PATH/" || true
          cp -r metrics "$REAL_PROJECT_PATH/" || true
          cp dvc.lock "$REAL_PROJECT_PATH/" || true
          echo "‚úÖ Sync Complete! Open VS Code to see results."

      - name: üì§ Git Commit DVC Lock
        if: success()
        run: |
          git config --local user.email "bot@pilltrack.ai"
          git config --local user.name "PillTrack Bot"
          git add dvc.lock
          git commit -m "ü§ñ auto: update dvc lockfile [skip ci]" || echo "No changes to commit"
          git push origin HEAD:main || echo "Push failed (maybe conflicts), skipping..."