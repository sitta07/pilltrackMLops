name: PillTrack MLOps Pipeline üíä

on:
  push:
    tags:
      - 'v*'          # Standard versioning
      - 'pill-v*'     # Specific for Pill
      - 'box-v*'      # Specific for Box
      - 'major-*'     # Major updates (Full Retrain)

jobs:
  train-and-deploy:
    name: Smart Training Pipeline
    runs-on: self-hosted
    
    env:
      PYTHONUNBUFFERED: "1"

    steps:
      # --- 1. SETUP PHASE ---
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup System Python & Venv
        run: |
          echo "üêç Checking System Python 3.10..."
          if [ ! -d "venv" ]; then
            /opt/homebrew/bin/python3.10 -m venv venv
          fi
          echo "$PWD/venv/bin" >> $GITHUB_PATH

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          # ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° transparent-background ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢
          pip install dvc[s3] python-dotenv transparent-background

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: DVC Pull Data
        run: |
          dvc remote modify myremote --local access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          dvc remote modify myremote --local secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          echo "‚è≥ Pulling ONLY RAW DATA (Avoiding Ghost Files)..."
          dvc pull data/raw_box.dvc data/raw_pill.dvc

      # --- 2. üß† THE BRAIN: LOGIC ‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ---
      - name: Analyze Tag & Execute Pipeline
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "üè∑Ô∏è Detected Tag: $TAG_NAME"

          # 1. Check Mode
          if [[ "$TAG_NAME" == *"major"* ]]; then
            MODE="FULL"
          else
            MODE="INCREMENTAL"
          fi

          # 2. Check Target
          if [[ "$TAG_NAME" == *"pill"* ]]; then
            TARGET="PILL"
          elif [[ "$TAG_NAME" == *"box"* ]]; then
            TARGET="BOX"
          else
            TARGET="BOTH"
          fi

          # 3. EXECUTION
          if [[ "$TARGET" == "PILL" ]] || [[ "$TARGET" == "BOTH" ]]; then
            echo "üíä Processing PILL..."
            if [[ "$MODE" == "INCREMENTAL" ]]; then
               dvc repro augment_pill && dvc commit train_pill && dvc repro evaluate_pill
            else
               dvc repro train_pill 
            fi
          fi

          if [[ "$TARGET" == "BOX" ]] || [[ "$TARGET" == "BOTH" ]]; then
            echo "üì¶ Processing BOX..."
            if [[ "$MODE" == "INCREMENTAL" ]]; then
               dvc repro augment_box && dvc commit train_box && dvc repro evaluate_box
            else
               dvc repro train_box -f
            fi
          fi

      # --- 3. üöÄ SMART DEPLOYMENT PHASE ---
      - name: Deploy to S3
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          CLEAN_VERSION=$(echo $VERSION | sed 's/major-//' | sed 's/pill-//' | sed 's/box-//')
          
          # üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Source Path ‡∏ï‡∏≤‡∏° Mode ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô
          # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Major (Full Retrain) ‡∏Ç‡∏≠‡∏á‡∏à‡∏∞‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà lite_v1
          # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Incremental ‡∏Ç‡∏≠‡∏á‡∏à‡∏∞‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà finetuned
          if [[ "$VERSION" == *"major"* ]]; then
             BASE_PATH="experiments/arcface_lite_v1"
             echo "üìÇ Deploying from Base (lite_v1)"
          else
             BASE_PATH="experiments/arcface_finetuned"
             echo "üìÇ Deploying from Finetuned"
          fi

          # ‚úÖ Deploy ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Target ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error Missing Files)
          
          # Check BOX
          if [ -d "$BASE_PATH/box" ]; then
            echo "üöÄ Deploying BOX version $CLEAN_VERSION..."
            python src/deploy.py --version $CLEAN_VERSION --path $BASE_PATH/box --note "Auto-deployed BOX ($VERSION)"
          fi

          # Check PILL
          if [ -d "$BASE_PATH/pill" ]; then
            echo "üöÄ Deploying PILL version $CLEAN_VERSION..."
            python src/deploy.py --version $CLEAN_VERSION --path $BASE_PATH/pill --note "Auto-deployed PILL ($VERSION)"
          fi