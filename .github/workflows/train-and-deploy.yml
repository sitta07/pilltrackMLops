name: PillTrack MLOps Pipeline üíä

on:
  push:
    tags:
      - 'v*'          # Standard versioning
      - 'pill-v*'     # Specific for Pill
      - 'box-v*'      # Specific for Box
      - 'major-*'     # Major updates (Full Retrain)

jobs:
  train-and-deploy:
    name: Smart Training Pipeline
    runs-on: self-hosted
    
    # ‚úÖ FIX 1: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Python ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ "‡∏≠‡∏° Log" (‡πÉ‡∏´‡πâ‡∏û‡πà‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
    env:
      PYTHONUNBUFFERED: "1"

    steps:
      # --- 1. SETUP PHASE ---
      - name: Checkout Code
        uses: actions/checkout@v3

      # ‚úÖ FIX 2: ‡πÉ‡∏ä‡πâ System Python + Venv (‡πÅ‡∏Å‡πâ Permission & ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô)
      - name: Setup System Python & Venv
        run: |
          echo "üêç Using System Python 3.10..."
          # ‡∏™‡∏£‡πâ‡∏≤‡∏á venv ‡∏ä‡∏∑‡πà‡∏≠ 'venv' (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
          /opt/homebrew/bin/python3.10 -m venv venv
          
          # Add venv path to GitHub Path so next steps use it automatically
          echo "$PWD/venv/bin" >> $GITHUB_PATH

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[s3] python-dotenv

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: DVC Pull Data
        run: |
          dvc remote modify myremote --local access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          dvc remote modify myremote --local secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          
          echo "‚è≥ Pulling ONLY RAW DATA (Avoiding Ghost Files)..."
          # ‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå .dvc ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô S3 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
          dvc pull data/raw_box.dvc data/raw_pill.dvc
      # --- 2. üß† THE BRAIN: LOGIC ‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ---
      - name: Analyze Tag & Execute Pipeline
        run: |
          # ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ refs/tags/ ‡∏≠‡∏≠‡∏Å
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "üè∑Ô∏è Detected Tag: $TAG_NAME"

          # 1. Check Mode (Major vs Incremental)
          if [[ "$TAG_NAME" == *"major"* ]]; then
            MODE="FULL"
            echo "üî• Mode: FULL RETRAINING (Major Update)"
          else
            MODE="INCREMENTAL"
            echo "‚ö° Mode: INCREMENTAL UPDATE (Fast Track)"
          fi

          # 2. Check Target (Pill vs Box vs Both)
          if [[ "$TAG_NAME" == *"pill"* ]]; then
            TARGET="PILL"
            echo "üéØ Target: PILL ONLY"
          elif [[ "$TAG_NAME" == *"box"* ]]; then
            TARGET="BOX"
            echo "üéØ Target: BOX ONLY"
          else
            TARGET="BOTH"
            echo "üéØ Target: BOTH (Pill & Box)"
          fi

          echo "----------------------------------------"

          # 3. EXECUTION LOGIC
          
          # === PILL PIPELINE ===
          if [[ "$TARGET" == "PILL" ]] || [[ "$TARGET" == "BOTH" ]]; then
            echo "üíä Processing PILL model..."
            if [[ "$MODE" == "INCREMENTAL" ]]; then
               dvc repro augment_pill
               dvc commit train_pill
               dvc repro evaluate_pill
            else
               dvc repro train_pill 
            fi
          else
            echo "‚è© Skipping PILL model..."
          fi

          # === BOX PIPELINE ===
          if [[ "$TARGET" == "BOX" ]] || [[ "$TARGET" == "BOTH" ]]; then
            echo "üì¶ Processing BOX model..."
            if [[ "$MODE" == "INCREMENTAL" ]]; then
               dvc repro augment_box
               dvc commit train_box
               dvc repro evaluate_box
            else
               dvc repro train_box
            fi
          else
             echo "‚è© Skipping BOX model..."
          fi

      # --- 3. DEPLOYMENT PHASE ---
      - name: Deploy to S3
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          
          # Clean version name
          CLEAN_VERSION=$(echo $VERSION | sed 's/major-//' | sed 's/pill-//' | sed 's/box-//')
          
          echo "üöÄ Deploying version $CLEAN_VERSION..."
          
          python src/deploy.py \
            --version $CLEAN_VERSION \
            --path experiments/arcface_finetuned \
            --note "Deployed via GitHub Actions ($VERSION)"