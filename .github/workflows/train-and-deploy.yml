name: PillTrack MLOps Pipeline üíä

on:
  push:
    tags:
      - 'v*'          # Catch all tags starting with v (e.g., v1.0)
      - 'pill-v*'     # Specific for Pill (e.g., pill-v1.0)
      - 'box-v*'      # Specific for Box (e.g., box-v1.0)
      - 'major-*'     # Catch all major updates (e.g., major-v2.0)

jobs:
  train-and-deploy:
    name: Smart Training Pipeline
    runs-on: self-hosted
    
    # üëá SOLUTION: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Path ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö Python Tool ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏µ‡πà‡πÄ‡∏≠‡∏á 
    # (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Permission Denied ‡∏ó‡∏µ‡πà /Users/runner)
    env:
      RUNNER_TOOL_CACHE: /Users/sittasahathum/Desktop/pilltrackMLops/actions-runner/_work/_tool

    steps:
      # --- 1. SETUP PHASE ---
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          # action ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ RUNNER_TOOL_CACHE ‡∏à‡∏≤‡∏Å env ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install dvc[s3] python-dotenv

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: DVC Pull Data
        run: |
          dvc remote modify myremote --local access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          dvc remote modify myremote --local secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          dvc pull
          # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏•‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Incremental)

      # --- 2. üß† THE BRAIN: LOGIC ‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ---
      - name: Analyze Tag & Execute Pipeline
        run: |
          # ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ refs/tags/ ‡∏≠‡∏≠‡∏Å
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "üè∑Ô∏è Detected Tag: $TAG_NAME"

          # 1. Check Mode (Major vs Incremental)
          if [[ "$TAG_NAME" == *"major"* ]]; then
            MODE="FULL"
            echo "üî• Mode: FULL RETRAINING (Major Update)"
          else
            MODE="INCREMENTAL"
            echo "‚ö° Mode: INCREMENTAL UPDATE (Fast Track)"
          fi

          # 2. Check Target (Pill vs Box vs Both)
          if [[ "$TAG_NAME" == *"pill"* ]]; then
            TARGET="PILL"
            echo "üéØ Target: PILL ONLY"
          elif [[ "$TAG_NAME" == *"box"* ]]; then
            TARGET="BOX"
            echo "üéØ Target: BOX ONLY"
          else
            TARGET="BOTH"
            echo "üéØ Target: BOTH (Pill & Box)"
          fi

          echo "----------------------------------------"

          # 3. EXECUTION LOGIC
          
          # === PILL PIPELINE ===
          if [[ "$TARGET" == "PILL" ]] || [[ "$TARGET" == "BOTH" ]]; then
            echo "üíä Processing PILL model..."
            if [[ "$MODE" == "INCREMENTAL" ]]; then
               # ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß: Augment -> ‡∏Ç‡πâ‡∏≤‡∏° Train Base -> Finetune -> Evaluate
               dvc repro augment_pill
               dvc commit train_pill
               dvc repro evaluate_pill
            else
               # ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°: ‡∏£‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏´‡∏°‡∏î
               dvc repro train_pill 
            fi
          else
            echo "‚è© Skipping PILL model..."
          fi

          # === BOX PIPELINE ===
          if [[ "$TARGET" == "BOX" ]] || [[ "$TARGET" == "BOTH" ]]; then
            echo "üì¶ Processing BOX model..."
            if [[ "$MODE" == "INCREMENTAL" ]]; then
               dvc repro augment_box
               dvc commit train_box
               dvc repro evaluate_box
            else
               dvc repro train_box
            fi
          else
             echo "‚è© Skipping BOX model..."
          fi

      # --- 3. DEPLOYMENT PHASE ---
      - name: Deploy to S3
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          
          # Clean version name (remove prefixes for folder name)
          CLEAN_VERSION=$(echo $VERSION | sed 's/major-//' | sed 's/pill-//' | sed 's/box-//')
          
          echo "üöÄ Deploying version $CLEAN_VERSION..."
          
          # Script ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏û‡πá‡∏Ñ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πà‡∏≤) ‡∏Ç‡∏∂‡πâ‡∏ô S3
          python src/deploy.py \
            --version $CLEAN_VERSION \
            --path experiments/arcface_finetuned \
            --note "Automated Deploy: $VERSION via GitHub Actions"