name: PillTrack MLOps Pipeline üíä

on:
  push:
    tags:
      - 'v*'          # Standard versioning
      - 'pill-v*'     # Specific for Pill
      - 'box-v*'      # Specific for Box
      - 'major-*'     # Major updates (Full Retrain)

jobs:
  train-and-deploy:
    name: Smart Training Pipeline
    runs-on: self-hosted
    
    # ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Python ‡∏≠‡∏° Log ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Debug ‡πÑ‡∏î‡πâ Real-time
    env:
      PYTHONUNBUFFERED: "1"

    steps:
      # --- 1. SETUP PHASE ---
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup System Python & Venv
        run: |
          echo "üêç Checking System Python 3.10..."
          if [ ! -d "venv" ]; then
            /opt/homebrew/bin/python3.10 -m venv venv
          fi
          # ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ venv ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Step ‡∏ï‡πà‡∏≠‡πÜ ‡πÑ‡∏õ
          echo "$PWD/venv/bin" >> $GITHUB_PATH

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[s3] python-dotenv transparent-background

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: DVC Pull Data
        run: |
          dvc remote modify myremote --local access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          dvc remote modify myremote --local secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          echo "‚è≥ Pulling RAW DATA from S3..."
          dvc pull data/raw_box.dvc data/raw_pill.dvc

      # --- 2. üß† THE BRAIN: EXECUTION LOGIC ---
      - name: Analyze Tag & Execute Pipeline
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "üè∑Ô∏è Detected Tag: $TAG_NAME"

          # ‚úÖ ‡πÉ‡∏ä‡πâ Regex ‡πÄ‡∏ä‡πá‡∏Ñ Mode ‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ major = ‡πÄ‡∏ó‡∏£‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
          if [[ "$TAG_NAME" =~ "major" ]]; then
            MODE="FULL"
          else
            MODE="INCREMENTAL"
          fi

          # ‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
          if [[ "$TAG_NAME" =~ "pill" ]]; then
            TARGET="PILL"
          elif [[ "$TAG_NAME" =~ "box" ]]; then
            TARGET="BOX"
          else
            TARGET="BOTH"
          fi

          echo "üöÄ Mode: $MODE | Target: $TARGET"
          echo "----------------------------------------"

          # ‚úÖ ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏∏‡∏ç‡πÅ‡∏à Git ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ dvc commit error)
          git rm -r --cached experiments/ || true

          # === üíä PILL PIPELINE ===
          if [[ "$TARGET" == "PILL" ]] || [[ "$TARGET" == "BOTH" ]]; then
            echo "üíä Processing PILL model..."
            if [[ "$MODE" == "FULL" ]]; then
               # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å evaluate_base (‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÑ‡∏õ‡∏î‡∏∂‡∏á train ‡∏°‡∏≤‡πÄ‡∏≠‡∏á) ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ -f ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
               dvc repro evaluate_base_pill -f
            else
               # Incremental Mode: augment -> evaluate (‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÑ‡∏õ‡∏î‡∏∂‡∏á finetune ‡∏°‡∏≤‡πÄ‡∏≠‡∏á)
               dvc repro augment_pill && dvc repro evaluate_pill
            fi
          fi

          # === üì¶ BOX PIPELINE ===
          if [[ "$TARGET" == "BOX" ]] || [[ "$TARGET" == "BOTH" ]]; then
            echo "üì¶ Processing BOX model..."
            if [[ "$MODE" == "FULL" ]]; then
               dvc repro evaluate_base_box -f
            else
               dvc repro augment_box && dvc repro evaluate_box
            fi
          fi

      # --- 3. üöÄ DEPLOYMENT PHASE (Fixed Bucket Arg) ---
      - name: Deploy to S3
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          CLEAN_VERSION=$(echo $VERSION | sed 's/major-//' | sed 's/pill-//' | sed 's/box-//')
          
          # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Base Folder ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà (‡∏ñ‡πâ‡∏≤ major ‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô lite_v1)
          if [[ "$VERSION" =~ "major" ]]; then
             BASE_PATH="experiments/arcface_lite_v1"
          else
             BASE_PATH="experiments/arcface_finetuned"
          fi

          echo "üìÇ Deploying from: $BASE_PATH"

          # ‚úÖ Capture Bucket Name from Secrets
          BUCKET="${{ secrets.S3_BUCKET_NAME }}"
          
          # Validation: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏´‡∏°
          if [ -z "$BUCKET" ]; then
            echo "‚ùå CRITICAL ERROR: Secret S3_BUCKET_NAME is empty!"
            exit 1
          fi

          # ‚úÖ ‡∏™‡πà‡∏á --bucket ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏£‡∏≠‡∏ö Quote ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß
          if [ -d "$BASE_PATH/box" ]; then
            echo "üì¶ Deploying BOX..."
            python src/deploy.py \
              --version "$CLEAN_VERSION" \
              --path "$BASE_PATH" \
              --type box \
              --bucket "$BUCKET"
          fi

          if [ -d "$BASE_PATH/pill" ]; then
            echo "üíä Deploying PILL..."
            python src/deploy.py \
              --version "$CLEAN_VERSION" \
              --path "$BASE_PATH" \
              --type pill \
              --bucket "$BUCKET"
          fi