schema: '2.0'
stages:
  preprocess_box:
    cmd: python src/data/remove_background.py --input data/raw_box --output 
      data/processed_box
    deps:
    - path: data/raw_box
      hash: md5
      md5: 75377884042bc78bede8053346a16ba9.dir
      size: 1602081107
      nfiles: 3227
    - path: src/data/remove_background.py
      hash: md5
      md5: 380ee30fedf4953bc5ee931841cd0ee7
      size: 4105
    outs:
    - path: data/processed_box
      hash: md5
      md5: 75377884042bc78bede8053346a16ba9.dir
      size: 1602081107
      nfiles: 3227
  split_box:
    cmd: python src/data/split_data.py --input data/processed_box --output 
      data/dataset_split_box
    deps:
    - path: data/processed_box
      hash: md5
      md5: 75377884042bc78bede8053346a16ba9.dir
      size: 1602081107
      nfiles: 3227
    - path: src/data/split_data.py
      hash: md5
      md5: 028308f6ef18eb9f907c165ea0303708
      size: 2863
    params:
      params.yaml:
        split:
          val_ratio: 0.2
          test_ratio: 0.1
          seed: 42
    outs:
    - path: data/dataset_split_box
      hash: md5
      md5: 51a5d277d912057f5f30cf6f3b685b7f.dir
      size: 1602081107
      nfiles: 3227
  augment_box:
    cmd: python src/data/augment.py --input data/dataset_split_box/train 
      --output data/dataset_train_final_box --type box
    deps:
    - path: data/dataset_split_box/train
      hash: md5
      md5: baa0ab50583c17e63b97019afa8077bf.dir
      size: 1116833647
      nfiles: 2248
    - path: src/data/augment.py
      hash: md5
      md5: ec107f83c0410206702b58e27f35bd69
      size: 5413
    params:
      params.yaml:
        augment.box:
          target_per_class: 350
          aug_params:
            rotate_limit: 15
            p_rotate: 0.5
            p_vertical_flip: 0.0
            p_horizontal_flip: 0.5
            p_brightness: 0.2
            shift_limit: 0.05
            scale_limit: 0.1
            perspective_scale: 0.1
    outs:
    - path: data/dataset_train_final_box
      hash: md5
      md5: 0c03dc50e5a4d773e8e75c4edcd4d203.dir
      size: 2726467881
      nfiles: 6744
  train_box:
    cmd: python src/train.py --train_dir data/dataset_train_final_box --val_dir 
      data/dataset_split_box/val --output_dir experiments/arcface_lite_v1/box 
      --type box
    deps:
    - path: data/dataset_split_box/val
      hash: md5
      md5: 63fab6ac8a33fc28cb7ea7c8ae4f7ba3.dir
      size: 322764419
      nfiles: 651
    - path: data/dataset_train_final_box
      hash: md5
      md5: 0c03dc50e5a4d773e8e75c4edcd4d203.dir
      size: 2726467881
      nfiles: 6744
    - path: src/train.py
      hash: md5
      md5: 88575db685bd4e641ddd07667f24e9cb
      size: 7344
    params:
      params.yaml:
        train.box:
          model_name: convnext_small
          img_size: 512
          batch_size: 16
          epochs: 2
          lr: 3e-05
          weight_decay: 0.05
          dropout: 0.4
          embed_dim: 512
          focal:
            gamma: 2.0
            alpha: 0.25
          num_workers: 8
    outs:
    - path: experiments/arcface_lite_v1/box
      hash: md5
      md5: 57b662a09210fd11fd3d224e16b41f46.dir
      size: 199592160
      nfiles: 2
  finetune_box:
    cmd: python src/finetune.py --data_dir data/dataset_train_final_box 
      --old_model_dir experiments/arcface_lite_v1/box --output_dir 
      experiments/arcface_finetuned/box --type box
    deps:
    - path: data/dataset_train_final_box
      hash: md5
      md5: b4c44745afc987219756bd180e1c09c6.dir
      size: 66695637
      nfiles: 546
    - path: experiments/arcface_lite_v1/box/best_model.pth
      hash: md5
      md5: c6d4fd6773c21cb9e9bec5c2f1a16b94
      size: 199574516
    - path: src/finetune.py
      hash: md5
      md5: 558370ee7ac08f84635b5ce182d9e368
      size: 7591
    params:
      params.yaml:
        train.box:
          model_name: convnext_small
          img_size: 224
          batch_size: 16
          epochs: 1
          lr: 0.0001
          weight_decay: 0.0001
          dropout: 0.5
          embed_dim: 512
          focal:
            gamma: 2.0
            alpha: 0.25
          seed: 42
          num_workers: 0
    outs:
    - path: experiments/arcface_finetuned/box
      hash: md5
      md5: 22e0ab3e82b1e6ede895e76726151a5f.dir
      size: 199574795
      nfiles: 2
  preprocess_pill:
    cmd: python src/data/remove_background.py --input data/raw_pill --output 
      data/processed_pill
    deps:
    - path: data/raw_pill
      hash: md5
      md5: b1ce7be7723d2b26898a7ce8e6a05351.dir
      size: 529053888
      nfiles: 6111
    - path: src/data/remove_background.py
      hash: md5
      md5: 380ee30fedf4953bc5ee931841cd0ee7
      size: 4105
    outs:
    - path: data/processed_pill
      hash: md5
      md5: b1ce7be7723d2b26898a7ce8e6a05351.dir
      size: 529053888
      nfiles: 6111
  split_pill:
    cmd: python src/data/split_data.py --input data/processed_pill --output 
      data/dataset_split_pill
    deps:
    - path: data/processed_pill
      hash: md5
      md5: b1ce7be7723d2b26898a7ce8e6a05351.dir
      size: 529053888
      nfiles: 6111
    - path: src/data/split_data.py
      hash: md5
      md5: 028308f6ef18eb9f907c165ea0303708
      size: 2863
    params:
      params.yaml:
        split:
          val_ratio: 0.2
          test_ratio: 0.1
          seed: 42
    outs:
    - path: data/dataset_split_pill
      hash: md5
      md5: 83845bbc534c61f22c18ad7b30287d33.dir
      size: 529053888
      nfiles: 6111
  augment_pill:
    cmd: python src/data/augment.py --input data/dataset_split_pill/train 
      --output data/dataset_train_final_pill --type pill
    deps:
    - path: data/dataset_split_pill/train
      hash: md5
      md5: 69d72b4f58b729d82c5f53d92886a10f.dir
      size: 368811640
      nfiles: 4264
    - path: src/data/augment.py
      hash: md5
      md5: ec107f83c0410206702b58e27f35bd69
      size: 5413
    params:
      params.yaml:
        augment.pill:
          target_per_class: 50
          aug_params:
            rotate_limit: 180
            p_rotate: 0.8
            p_vertical_flip: 0.5
            p_horizontal_flip: 0.5
            p_brightness: 0.2
            blur_limit: 3
    outs:
    - path: data/dataset_train_final_pill
      hash: md5
      md5: ff78c9ca790c206c8ae8d871acd7b367.dir
      size: 296676938
      nfiles: 4264
  train_pill:
    cmd: python src/train.py --train_dir data/dataset_train_final_pill --val_dir
      data/dataset_split_pill/val --output_dir experiments/arcface_lite_v1/pill 
      --type pill
    deps:
    - path: data/dataset_split_pill/val
      hash: md5
      md5: ff8e1ba4f113974f06f67278fdd97841.dir
      size: 1630937
      nfiles: 24
    - path: data/dataset_train_final_pill
      hash: md5
      md5: 8b108e4d7b2a9338b54707c427fba110.dir
      size: 48404923
      nfiles: 424
    - path: src/train.py
      hash: md5
      md5: 314253bc0a7b2e072cde9e1a4b085633
      size: 5384
    params:
      params.yaml:
        train.pill:
          model_name: convnext_small
          img_size: 224
          batch_size: 16
          epochs: 2
          lr: 0.0001
          weight_decay: 0.0001
          dropout: 0.3
          embed_dim: 512
          focal:
            gamma: 2.0
            alpha: 0.25
          seed: 42
          num_workers: 0
    outs:
    - path: experiments/arcface_lite_v1/pill
      hash: md5
      md5: 87d5b0e86cc8b48218990e52df7abe85.dir
      size: 199570625
      nfiles: 2
  finetune_pill:
    cmd: python src/finetune.py --data_dir data/dataset_train_final_pill 
      --old_model_dir experiments/arcface_lite_v1/pill --output_dir 
      experiments/arcface_finetuned/pill --type pill
    deps:
    - path: data/dataset_train_final_pill
      hash: md5
      md5: 8b108e4d7b2a9338b54707c427fba110.dir
      size: 48404923
      nfiles: 424
    - path: experiments/arcface_lite_v1/pill/best_model.pth
      hash: md5
      md5: 7dfbebdd34d095ff984947039866a855
      size: 199570420
    - path: src/finetune.py
      hash: md5
      md5: 64c5187bcb82743760bcfe899b3a653a
      size: 7503
    params:
      params.yaml:
        train.pill:
          model_name: convnext_small
          img_size: 224
          batch_size: 16
          epochs: 2
          lr: 0.0001
          weight_decay: 0.0001
          dropout: 0.3
          embed_dim: 512
          focal:
            gamma: 2.0
            alpha: 0.25
          seed: 42
          num_workers: 0
    outs:
    - path: experiments/arcface_finetuned/pill
      hash: md5
      md5: 87d5b0e86cc8b48218990e52df7abe85.dir
      size: 199570625
      nfiles: 2
  evaluate_pill:
    cmd: python src/evaluate.py --test_dir data/dataset_split_pill/test 
      --model_dir experiments/arcface_finetuned/pill --metrics_out 
      metrics/pill_metrics.json --type pill --threshold 20.0
    deps:
    - path: data/dataset_split_pill/test
      hash: md5
      md5: d4b8329b8b3c4cfaa382dada8fc44466.dir
      size: 839755
      nfiles: 13
    - path: experiments/arcface_finetuned/pill/best_model.pth
      hash: md5
      md5: 1118c8a791b20dafae320d9fde30cf30
      size: 199570420
    - path: src/evaluate.py
      hash: md5
      md5: 794c123055a1eb89e7dea88a05ced291
      size: 3375
    outs:
    - path: metrics/pill_metrics.json
      hash: md5
      md5: 0297a3f22fdf65acf2c59427c4c6d9a6
      size: 57
  evaluate_box:
    cmd: python src/evaluate.py --test_dir data/dataset_split_box/test 
      --model_dir experiments/arcface_finetuned/box --metrics_out 
      metrics/box_metrics.json --type box --threshold 70.0
    deps:
    - path: data/dataset_split_box/test
      hash: md5
      md5: 3f20a592dcef83d532c61cbf5a889f5e.dir
      size: 2460955
      nfiles: 18
    - path: experiments/arcface_finetuned/box/best_model.pth
      hash: md5
      md5: 6fd2bc3491f2029888f39061ec44ff3d
      size: 199574516
    - path: src/evaluate.py
      hash: md5
      md5: 794c123055a1eb89e7dea88a05ced291
      size: 3375
    outs:
    - path: metrics/box_metrics.json
      hash: md5
      md5: 70b337cf3adcdd2ef25f409663c5b2bc
      size: 57
